# Vision Testing Container - Windows x86_64 (via cross-compilation)
# Note: This container cross-compiles for Windows, tests are limited to build verification
FROM ubuntu:22.04

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    pkg-config \
    libssl-dev \
    libclang-dev \
    git \
    curl \
    python3 \
    python3-pip \
    jq \
    && rm -rf /var/lib/apt/lists/*

# Install Rust with Windows cross-compilation target
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup target add x86_64-pc-windows-gnu

# Install MinGW for Windows cross-compilation
RUN apt-get update && apt-get install -y \
    gcc-mingw-w64-x86-64 \
    g++-mingw-w64-x86-64 \
    && rm -rf /var/lib/apt/lists/*

# Configure cargo for Windows cross-compilation  
RUN mkdir -p /root/.cargo && \
    printf '[target.x86_64-pc-windows-gnu]\nlinker = "x86_64-w64-mingw32-gcc"\n' > /root/.cargo/config.toml

# Set working directory
WORKDIR /workspace

# Copy source code
COPY . .

# Remove private vision dependency for CI builds (cannot access private repo in CI)
RUN sed -i '/shimmy-vision.*git.*shimmy-vision-private/d' Cargo.toml || true

# Remove vision feature from features list  
RUN sed -i 's/vision = \[.*\]/vision = []/' Cargo.toml || true

# Build with basic features for Windows (no vision due to private repo removal)
# Using GNU target since MSVC isn't available in Linux
RUN cargo build --release --target x86_64-pc-windows-gnu --features llama 2>&1 || echo "Build attempted"

# Create test script file
RUN printf '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting Vision Cross-Platform Tests"\n\
echo "Platform: Windows x86_64 (cross-compiled)"\n\
echo "========================================"\n\
\n\
# Check if build succeeded\n\
BINARY="target/x86_64-pc-windows-gnu/release/shimmy.exe"\n\
if [ -f "$BINARY" ]; then\n\
    echo "Build SUCCESS: $BINARY exists"\n\
    BINARY_SIZE=$(stat -c%%s "$BINARY" 2>/dev/null || echo "0")\n\
    echo "Binary size: $BINARY_SIZE bytes"\n\
    BUILD_SUCCESS=true\n\
else\n\
    echo "Build FAILED: $BINARY not found"\n\
    ls -la target/x86_64-pc-windows-gnu/release/ 2>/dev/null || echo "Release dir not found"\n\
    BUILD_SUCCESS=false\n\
fi\n\
\n\
# Generate test results JSON\n\
cat > /workspace/test-results-windows.json << RESULTS\n\
{\n\
  "platform": "windows-x86_64",\n\
  "build_target": "x86_64-pc-windows-gnu",\n\
  "success": $BUILD_SUCCESS,\n\
  "binary_exists": $BUILD_SUCCESS,\n\
  "binary_path": "$BINARY",\n\
  "binary_size_bytes": ${BINARY_SIZE:-0},\n\
  "test_type": "cross-compile-build-only",\n\
  "note": "Runtime testing requires native Windows or Wine with proper MSVC runtime",\n\
  "cpu_only": true,\n\
  "total_duration_seconds": 0\n\
}\n\
RESULTS\n\
\n\
echo "Test results written to /workspace/test-results-windows.json"\n\
cat /workspace/test-results-windows.json\n\
\n\
if [ "$BUILD_SUCCESS" = "false" ]; then\n\
    exit 1\n\
fi\n\
\n\
echo "Windows cross-compilation test completed"\n\
' > /usr/local/bin/run_vision_tests.sh

RUN chmod +x /usr/local/bin/run_vision_tests.sh

# Default command
CMD ["/usr/local/bin/run_vision_tests.sh"]
