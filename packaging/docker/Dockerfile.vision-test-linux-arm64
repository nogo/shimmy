# Vision Testing Container - Linux ARM64 (via cross-compilation)
# Note: This container cross-compiles for ARM64, tests are limited to build verification
FROM ubuntu:22.04

# Install system dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    pkg-config \
    libssl-dev \
    libclang-dev \
    git \
    curl \
    python3 \
    python3-pip \
    jq \
    crossbuild-essential-arm64 \
    && rm -rf /var/lib/apt/lists/*

# Install Rust with ARM64 target
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"
RUN rustup target add aarch64-unknown-linux-gnu

# Configure cargo for ARM64 cross-compilation  
RUN mkdir -p /root/.cargo && \
    printf '[target.aarch64-unknown-linux-gnu]\nlinker = "aarch64-linux-gnu-gcc"\n' > /root/.cargo/config.toml

# Set working directory
WORKDIR /workspace

# Copy source code
COPY . .

# Remove private vision dependency for CI builds (cannot access private repo in CI)
RUN sed -i '/shimmy-vision.*git.*shimmy-vision-private/d' Cargo.toml || true

# Remove vision feature from features list  
RUN sed -i 's/vision = \[.*\]/vision = []/' Cargo.toml || true

# Build with basic features for ARM64 (no vision due to private repo removal)
RUN cargo build --release --target aarch64-unknown-linux-gnu --features llama 2>&1 || echo "Build attempted"

# Create test script file
RUN printf '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting Vision Cross-Platform Tests"\n\
echo "Platform: Linux ARM64 (cross-compiled)"\n\
echo "======================================="\n\
\n\
# Check if build succeeded\n\
BINARY="target/aarch64-unknown-linux-gnu/release/shimmy"\n\
if [ -f "$BINARY" ]; then\n\
    echo "Build SUCCESS: $BINARY exists"\n\
    BINARY_SIZE=$(stat -c%%s "$BINARY" 2>/dev/null || echo "0")\n\
    echo "Binary size: $BINARY_SIZE bytes"\n\
    # Check if its a valid ELF ARM64 binary\n\
    FILE_TYPE=$(file "$BINARY" | grep -o "ARM aarch64" || echo "unknown")\n\
    echo "File type: $FILE_TYPE"\n\
    BUILD_SUCCESS=true\n\
else\n\
    echo "Build FAILED: $BINARY not found"\n\
    ls -la target/aarch64-unknown-linux-gnu/release/ 2>/dev/null || echo "Release dir not found"\n\
    BUILD_SUCCESS=false\n\
fi\n\
\n\
# Generate test results JSON\n\
cat > /workspace/test-results-linux-arm64.json << RESULTS\n\
{\n\
  "platform": "linux-arm64",\n\
  "build_target": "aarch64-unknown-linux-gnu",\n\
  "success": $BUILD_SUCCESS,\n\
  "binary_exists": $BUILD_SUCCESS,\n\
  "binary_path": "$BINARY",\n\
  "binary_size_bytes": ${BINARY_SIZE:-0},\n\
  "test_type": "cross-compile-build-only",\n\
  "note": "Runtime testing requires ARM64 hardware or QEMU user-mode emulation",\n\
  "cpu_only": true,\n\
  "total_duration_seconds": 0\n\
}\n\
RESULTS\n\
\n\
echo "Test results written to /workspace/test-results-linux-arm64.json"\n\
cat /workspace/test-results-linux-arm64.json\n\
\n\
if [ "$BUILD_SUCCESS" = "false" ]; then\n\
    exit 1\n\
fi\n\
\n\
echo "Linux ARM64 cross-compilation test completed"\n\
' > /usr/local/bin/run_vision_tests.sh

RUN chmod +x /usr/local/bin/run_vision_tests.sh

# Default command
CMD ["/usr/local/bin/run_vision_tests.sh"]
